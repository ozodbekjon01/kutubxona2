<!DOCTYPE html>
<html lang="uz">
<head>
    <link rel="icon" type="image/png" href="favicon.jpg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://kit.fontawesome.com/4e0d0fae80.js" crossorigin="anonymous"></script>

</head>
<body> <!-- Yengil kulrang fon -->

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container text-white">
            <a class="navbar-brand" href="index.html">
                <img src="im.png" alt="Logotip" width="300">
            </a>
            <h2>
                <i class="fas fa-user-circle"></i> 
                <span id="username">Foydalanuvchi</span>
            </h2>
            <a href="index.html" class="btn btn-light"><i class="fas fa-home"></i> Menyu</a>
        </div>
    </nav>

    <main class="container my-4">
        <div class="mt-4 d-flex justify-content-between align-items-center">
            <h3 class="text-center flex-grow-1">
                <i class="fas fa-book"></i> Mening Kitoblarim
            </h3>
            <div class="d-flex gap-2">
                <a href="add_book.html" class="btn btn-success">
                    <i class="fas fa-plus"></i> Yangi Kitob Qoâ€˜shish
                </a>
                <a href="login.html" class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Chiqish
                </a>
            </div>
        </div>

        <div id="loading" class="text-center my-3" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Yuklanmoqda...</p>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered mt-3">
                <thead class="table-primary">
                    <tr>
                        <th>#</th>
                        <th>Muqova</th>
                        <th>Nomi</th>
                        <th>amallar</th>
                        
                    </tr>
                </thead>
                <tbody id="user-books" >
                    <!-- Kitoblar shu joyga yuklanadi -->
                </tbody>
            </table>
        </div>
    </main>

    <footer class="bg-dark text-white text-center py-3 mt-4">
        <p>&copy; 2025 CyberLibrary.uz | Barcha huquqlar himoyalangan.
        Talab va takliflaringiz bo'lsa <a href="https://t.me/Ozodbek_2616" class="text-info">admin</a> bilan bog'lanishingiz mumkin</p>
    </footer>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let username = localStorage.getItem("username");
            if (!username) {
                window.location.href = "login.html";
            } else {
                document.getElementById("username").textContent = username;
                loadUserBooks(username);
            }
        });

        function loadUserBooks(username) {
            document.getElementById("loading").style.display = "block";
            fetch(`http://localhost:5000/user_books/${username}`)
                .then(response => response.json())
                .then(books => {

                    let userBooks = document.getElementById("user-books");

                    userBooks.innerHTML = books.length ? books.map((book, index) => `

                        <tr>
                            <td>${index + 1}</td>
                            <td><img src="${book.cover}" alt="Muqova" width="50"></td>
                            <td>${book.title}</td>
                            <td><a href="http://127.0.0.1:5000/${book.filename}" class="btn btn-sm btn-primary mt-1">ðŸ“¥ Yuklab olish</a>
                            <a href="book.html?title=${encodeURIComponent(book.title)}" class="btn btn-sm btn-info mt-1">Kitobni koâ€˜rish</a>
                            <button class="btn btn-danger btn-sm delete-btn" data-title="${book.title}">ðŸ—‘ Oâ€˜chirish</button></td>
                        </tr>
                    `).join('') : "<tr><td colspan='5' class='text-center text-muted'>ðŸ“– Siz hali kitob qoâ€˜shmagansiz.</td></tr>";
                    document.getElementById("loading").style.display = "none";

                    // Oâ€˜chirish tugmalarini ishlashini taâ€™minlash
                    document.querySelectorAll(".delete-btn").forEach(button => {
                        button.addEventListener("click", function () {
                            let bookTitle = this.getAttribute("data-title");

                            if (!bookTitle) {
                                console.error("Kitob nomi aniqlanmadi.");
                                alert("Xatolik: Kitob nomi aniqlanmadi!");
                                return;
                            }

                            if (confirm(`Rostdan ham "${bookTitle}" kitobini oâ€˜chirmoqchimisiz?`)) {
                                deleteBook(bookTitle);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error("Xatolik:", error);
                    document.getElementById("loading").style.display = "none";
                });
        }

        function logout() {
            localStorage.removeItem("username");
            window.location.href = "login.html";
        }

        function deleteBook(bookTitle) {
            fetch(`http://localhost:5000/books/${encodeURIComponent(bookTitle)}`, {

                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title: bookTitle })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadUserBooks(localStorage.getItem("username")); // Sahifani yangilash
            })
            .catch(error => console.error("Xatolik:", error));
        }


    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>